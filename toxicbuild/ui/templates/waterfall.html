{% extends "base.html" %}

{% block main_area %}
{% include "step_details_modal.html" %}
{% include "buildset_details_modal.html" %}
<input type="hidden" id="waterfall-repo-name" value="{{repo_name}}"/>
<table>
  <tbody class="waterfall-table">
    <tr class="waterfall-row">
      <td class="buildsets-column placeholder">
	<ul>
	  <li class="buildset buildset-placeholder">
	    buildsets
	  </li>
	</ul>
      </td>
      {% for builder in builders %}
      <td class="builders-column">
	<ul class="">
	  <li class="builder builder-{{builder.status}}" id="{{builder.id}}">
	    {{builder.name}}
	  </li>
	</ul>
      </td>
      {% end %}
    </tr>
    {% for buildset in buildsets %}
    <tr class="waterfall-row">
      <td class="buildsets-column">
	<ul class="">
	  <li class="buildset" id="buildset-{{buildset.id}}">
	    commit: {{buildset.commit[:8]}}<br/>
	    branch: {{buildset.branch}}<br/>
	    <button type="button" class="btn btn-step-details btn-buildset-details btn-sm"
		    data-toggle="modal"
		    data-target="#buildsetDetailsModal"
		    data-dismiss="modal"
		    data-buildset-commit="{{buildset.commit}}"
		    data-buildset-branch="{{buildset.branch}}"
		    data-buildset-commit-author="{{buildset.author}}"
		    data-buildset-commit-title="{{buildset.title}}"
		    data-buildset-created="{{buildset.created}}">
	      details
	    </button>

	    <button type="button" class="btn btn-default btn-rebuild btn-rebuild-buildset btn-sm"
		    data-buildset-commit="{{buildset.commit}}"
		    data-buildset-branch="{{buildset.branch}}">

	      <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
	    </button>

	  </li>
	</ul>
      </td>
      {% for i, build in enumerate(ordered_builds(buildset.builds)) %}
      <td class="builder-column">
	{% for ending in get_ending(build, i, builders)%}
   	  {% raw ending %}
	{% end %}
	<ul>
	  <li class="step step-{{build.status}}">
	    Build - {{build.status}}
	    <button type="button" class="btn btn-default btn-rebuild btn-rebuild-build btn-sm"
		    data-buildset-commit="{{buildset.commit}}"
		    data-buildset-branch="{{buildset.branch}}"
		    data-builder-name="{{ get_builder(builders, i).name}}">

	      <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>
	  </li>
	  {% for step in build.steps %}
	  <li class="step step-{{step.status}}">
	    <div class="build-step-info-container">
	      {{step.name}} - {{step.status}}
	      <button type="button" class="btn btn-step-details btn-sm"
		      data-toggle="modal"
		      data-target="#stepDetailsModal"
		      data-dismiss="modal"
		      data-step-command="{{step.command}}"
		      data-step-output="{{step.output}}"
		      data-step-status="{{step.status}}"
		      data-step-start="{{step.started}}"
		      data-step-end="{{step.finished}}">
		details
	      </button>
	    </div>
	  </li>
	  {% end %}
	</ul>
      </td>
      {% end %}
    </tr>
    {% end %}
  </tbody>
</table>
{% end %}

{% block js_bottom %}
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="{{static_url}}toxicbuild/js/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="{{static_url}}toxicbuild/js/bootstrap.min.js"></script>
<script src="{{static_url}}toxicbuild/js/utils.js"></script>
<script src="{{static_url}}toxicbuild/js/waterfall.js"></script>
<script>TOXICDEBUG = true;</script>
{% end %}
